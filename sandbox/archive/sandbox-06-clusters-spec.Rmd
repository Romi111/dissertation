---
title: "sandbox-06"
author: "Joshua Rosenberg"
date: "12/27/2017"
output: html_document
---

# Sandbox - 06

### Background

This is a sandbox for exploring the data, in preparation for adding to the results section.

This document is organized around two sets of model specifications:

1. Fit using the R package `mclust`
2. Fit using the commerical software `MPlus`

Both are interfaced to through the `tidyLPA` package. 

### Models that are specified

**mclust**

For models fit using `mclust`, eight model specifications are tested, where all five refers to the variables for cognitive (learning), behavioral (hard working), and affective (enjoy), and challenge and competence, where three refers to just the three engagement measures. Note that the prior is to regularize the parameter estimates to be more less likely to be extreme (and therefore to be less likely to lead to convergence problems, but possibly less meaningful / interpretable).

* All five variables w/ no prior
* All five variables standardized w/ prior

*MPlus*

* All five variables
* All five variables standardized 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = F, warning = F, cache = T)
```

```{r, loading-packages}
library(tidyverse)
library(lmerTest)
library(lme4)
library(corrr)
library(jmRtools)
library(tidyLPA)
library(sjPlot)
```

```{r, loading-data, eval = F}
esm <- read_csv("/Volumes/SCHMIDTLAB/PSE/data/STEM-IE/STEM-IE-esm.csv")
pre_survey_data_processed <- read_csv("/Volumes/SCHMIDTLAB/PSE/data/STEM-IE/STEM-IE-pre-survey.csv")
post_survey_data_partially_processed <- read_csv("/Volumes/SCHMIDTLAB/PSE/data/STEM-IE/STEM-IE-post-survey.csv")
video <- read_csv("/Volumes/SCHMIDTLAB/PSE/data/STEM-IE/STEM-IE-video.csv")
pqa <- read_csv("/Volumes/SCHMIDTLAB/PSE/data/STEM-IE/STEM-IE-pqa.csv")
attendance <- read_csv("/Volumes/SCHMIDTLAB/PSE/data/STEM-IE/STEM-IE-attendance.csv")
class_data <- read_csv("/Volumes/SCHMIDTLAB/PSE/data/STEM-IE/STEM-IE-class-video.csv")
demographics <- read_csv("/Volumes/SCHMIDTLAB/PSE/data/STEM-IE/STEM-IE-demographics.csv")
pm <- read_csv("/Volumes/SCHMIDTLAB/PSE/Data/STEM-IE/STEM-IE-program-match.csv")
```

```{r}
# save.image("~/desktop/sandbox-01.Rdata")
load("~/desktop/sandbox-01.Rdata")
```

```{r, processing-some-data}
attendance <- rename(attendance, participant_ID = ParticipantID)
attendance <- mutate(attendance, prop_attend = DaysAttended / DaysScheduled, 
                     participant_ID = as.integer(participant_ID))
attendance <- select(attendance, participant_ID, prop_attend)

demographics <- filter(demographics, participant_ID!= 7187)
demographics <- left_join(demographics, attendance)

esm$overall_engagement <- jmRtools::composite_mean_maker(esm, hard_working, concentrating, enjoy, interest)
```

```{r, joining-df}
df <- left_join(esm, pre_survey_data_processed, by = "participant_ID") # df & post-survey
df <- left_join(df, video, by = c("program_ID", "response_date", "sociedad_class", "signal_number")) # df & video
df <- left_join(df, demographics, by = c("participant_ID", "program_ID")) # df and demographics
```

```{r, proc-variables, echo = F}
df$participant_ID <- as.factor(df$participant_ID)
df$program_ID <- as.factor(df$program_ID)
df$beep_ID <- as.factor(df$beep_ID)
df$beep_ID_new <- as.factor(df$beep_ID_new)

df$youth_activity_rc <- ifelse(df$youth_activity == "Off Task", "Not Focused", df$youth_activity)

df$youth_activity_rc <- ifelse(df$youth_activity_rc == "Student Presentation" | df$youth_activity_rc == "Problem Solving", "Creating Product", df$youth_activity_rc)

df$youth_activity_rc <- ifelse(df$youth_activity_rc == "Showing Video", "Program Staff Led", df$youth_activity_rc)

df$youth_activity_rc <- as.factor(df$youth_activity_rc)

df$youth_activity_rc <- forcats::fct_relevel(df$youth_activity_rc, "Not Focused")

df$relevance <- jmRtools::composite_mean_maker(df, use_outside, future_goals, important)
```

```{r processing-demographics, echo = F, eval = F}
df$urm <- ifelse(df$race %in% c("White", "Asian"), 0, 1)
df$race <- as.factor(df$race)
df$race <- fct_lump(df$race, n = 2)
df$race_other <- fct_relevel(df$race, "Other")
df$gender_female <- as.factor(df$gender) # female is comparison_group
df$gender_female <- ifelse(df$gender_female == "F", 1, 
                           ifelse(df$gender_female == "M", 0, NA))
```

```{r}
pqa <- mutate(pqa, 
              active = active_part_1 + active_part_2,
              ho_thinking = ho_thinking_1 + ho_thinking_2 + ho_thinking_3,
              belonging = belonging_1 + belonging_2,
              agency = agency_1 + agency_2 + agency_3 + agency_4,
              youth_development_overall = active_part_1 + active_part_2 + ho_thinking_1 + ho_thinking_2 + ho_thinking_3 + belonging_1 + belonging_2 + agency_1 + agency_2 + agency_3 + agency_4,
              making_observations = stem_sb_8,
              data_modeling = stem_sb_2 + stem_sb_3 + stem_sb_9,
              interpreting_communicating = stem_sb_6,
              generating_data = stem_sb_4,
              asking_questions = stem_sb_1,
              stem_sb = stem_sb_1 + stem_sb_2 + stem_sb_3 + stem_sb_4 + stem_sb_5 + stem_sb_6 + stem_sb_7 + stem_sb_8 + stem_sb_9)

# pqa <- rename(pqa, sixth_math_sociedad = sixth_math)
# pqa <- rename(pqa, seventh_math_sociedad = seventh_math)
# pqa <- rename(pqa, eighth_math_sociedad = eighth_math)
# pqa <- rename(pqa, dance_sociedad = dance)
# pqa <- rename(pqa, robotics_sociedad = robotics)

pqa$sociedad_class <- ifelse(pqa$eighth_math == 1, "8th Math",
                             ifelse(pqa$seventh_math == 1, "7th Math",
                                    ifelse(pqa$sixth_math == 1, "6th Math",
                                           ifelse(pqa$robotics == 1, "Robotics",
                                                  ifelse(pqa$dance == 1, "Dance", NA)))))

pqa <- rename(pqa, 
              program_ID = SiteIDNumeric,
              response_date = resp_date,
              signal_number = signal)

pqa$program_ID <- as.character(pqa$program_ID)

df <- left_join(df, pqa, by = c("response_date", "program_ID", "signal_number", "sociedad_class"))
```

```{r}
df <- df %>% 
    mutate(youth_activity_three = case_when(
        youth_activity_rc == "Creating Product" ~ "Creating Product",
        youth_activity_rc == "Basic Skills Activity" ~ "Basic Skills Activity",
        TRUE ~ "Other"
    ))

df$youth_activity_three <- fct_relevel(df$youth_activity_three, 
                                       "Other")
```

```{r}

# <!-- Cognitive engagement	As you were signaled, were you learning anything or getting better at something? -->
# <!-- Behavioral engagement	As you were signaled, how hard were you working? -->
# <!-- Affective engagement	As you were signaled, did you enjoy what you are doing? -->
# <!-- Perceived challenge	As you were signaled, how challenging was the main activity? -->
# <!-- Perceived competence	As you were signaled, were you good at the main activity? -->

library(jmRtools)

df <- df %>% 
    mutate(dm_cog_eng = learning,
           dm_beh_eng = hard_working,
           dm_aff_eng = enjoy,
           dm_challenge = challenge,
           dm_competence = good_at) %>% 
    rename(ssb_predict = stem_sb_1,
           ssb_model = stem_sb_2 ,
           ssb_analyze = stem_sb_3,
           ssb_measure = stem_sb_4,
           ssb_tools = stem_sb_5,
           ssb_precision = stem_sb_6,
           ssb_vocabulary = stem_sb_7,
           ssb_classification = stem_sb_8,
           ssb_symbols = stem_sb_9) %>% 
    mutate(dm_ask = ssb_predict,
           dm_obs = ssb_classification,
           dm_gen = ifelse(ssb_measure == 1 | ssb_precision == 1, 1, 0),
           dm_mod = ifelse(ssb_model == 1 | ssb_analyze == 1, 1, 0),
           dm_com = ssb_symbols) %>% 
    mutate(ov_cog_eng = (important + future_goals) / 2,
           ov_beh_eng = (hard_working + concentrating) / 2,
           ov_aff_eng = (enjoy + interest) / 2)
```

```{r}
out <- df %>% 
    group_by(program_ID) %>% 
    select(contains("ssb")) %>% 
    summarize_all(sum, na.rm = T)

out1 <- pqa %>% 
    select(contains("stem"), -sum_stem_sb, -stem_sb) %>% 
    summarize_all(sum, na.rm = T) / 236

names(out1) <- df %>% select(contains("ssb")) %>% names()

pqa_out <- pqa %>% 
    group_by(program_ID) %>% 
    select(contains("stem"), -sum_stem_sb, -stem_sb) %>% 
    summarize_all(sum, na.rm = T)

names(pqa_out) <- names(out)
```

# 0 general solutions w/ composite

```{r}
df <- mutate(df, dm_ov_en = composite_mean_maker(df, dm_cog_eng, dm_beh_eng, dm_aff_eng))

compare_models_mplus(df, dm_ov_en, dm_challenge, dm_competence, starts = c(100, 20), st_iterations=20)

create_profiles_mplus(df, dm_ov_en, dm_challenge, dm_competence, starts = c(100, 20), st_iterations=20, n_profiles = 6, model = 1) %>% plot_profiles_mplus()

```

# 1. Specific solutions

```{r, testing-profiles}
create_profiles_mplus(df, 
                      dm_ov_en, dm_challenge, dm_competence,
                      n_profiles = 7, model = 2) %>% 
    plot_profiles_mplus()
```

```{r, 6-p-m-2}
m <- create_profiles_mplus(df, dm_cog_eng, dm_beh_eng, dm_aff_eng, dm_challenge, dm_competence, n_profiles=6, model = 2)

# m[[2]]$C <- factor(m[[2]]$C, levels = c(3, 1, 6, 2, 5, 4))

p <- plot_profiles_mplus(m) + 
    scale_fill_brewer("", palette="Set2", labels = c("Affective Engagement", "Behavioral Engagement", "Challenge", "Cognitive Engagement", "Competence")) + ylab("Z-score") + 
    scale_x_discrete("", labels = c(
        "Highly Competent but not Engaged (n = 266)",
        "Engaged but not Challenged (n = 524)",
        "Universally Low (n = 517)",
        "Full (n = 982)",
        "Pleasurable (n = 410)",
        "Highly Challenged (n = 259)"
    )) +
    theme(text = element_text(size = 14, family = "Helvetica Neue")) +
    theme(axis.text.y = element_text(margin = margin(t = 0, r = 0, b = 0, l = 60)))

p

# ggsave("2018-1-19-mep-final.png", width = 12, height = 9)
```

```{r, proc-profiles}
cc <- df %>% select(dm_cog_eng:dm_competence) %>% complete.cases()
C <- m[[2]] %>% pull(C)

C_p <- select(m[[2]], CPROB1:CPROB6) %>% 
    apply(MARGIN = 1, FUN = max)

select(m[[2]], CPROB1:CPROB6)

df_ss <- df[cc, ]
df_ss$profile <- C
df_ss$profile_p <- C_p

d <- df_ss %>% select(contains("dm"), participant_ID, program_ID, beep_ID = beep_ID_new, profile, profile_p, overall_pre_interest)

d <- d %>% 
    mutate(
        profile_1 = ifelse(profile == 1, 1, 0),
        profile_2 = ifelse(profile == 2, 1, 0),
        profile_3 = ifelse(profile == 3, 1, 0),
        profile_4 = ifelse(profile == 4, 1, 0),
        profile_5 = ifelse(profile == 5, 1, 0),
        profile_6 = ifelse(profile == 6, 1, 0),
        profile_1_p = ifelse(profile == 1, profile_p, 0),
        profile_2_p = ifelse(profile == 2, profile_p, 0),
        profile_3_p = ifelse(profile == 3, profile_p, 0),
        profile_4_p = ifelse(profile == 4, profile_p, 0),
        profile_5_p = ifelse(profile == 5, profile_p, 0),
        profile_6_p = ifelse(profile == 6, profile_p, 0),
    )
```



```{r, psych-describe}
d %>% psych::describe()
```
```{r, plots}

safe_sum <- function(x){
    sum(x, na.rm = T)
}

x <- d %>% 
    select(profile, dm_ask:dm_com) %>% 
    group_by(profile) %>% 
    summarize_all(funs(safe_sum, n())) %>% 
    select(profile, contains("sum"), n = dm_ask_n) %>% 
    gather(key, val, -profile, -n) %>% 
    mutate(prop = val/n) %>% 
    select(profile, key, prop) %>% 
    mutate(key = str_sub(key, end = 6))

ggplot(x, aes(x = profile, y = prop, fill = key)) +
    geom_col()

d %>% count(profile)
```

```{r, null-models}
m1 <- glmer(profile_1 ~ 1 +
                (1 | participant_ID) +
                (1 | beep_ID) +
                (1 | program_ID),
            family = binomial(link = "logit"),
            data = d)

summary(m1)
sjstats::icc(m1)

m2 <- glmer(profile_2 ~ 1 +
                (1 | participant_ID) +
                (1 | beep_ID) +
                (1 | program_ID),
            family = binomial(link = "logit"),
            data = d)

summary(m2)
sjstats::icc(m2)

m3 <- glmer(profile_3 ~ 1 +
                (1 | participant_ID) +
                (1 | beep_ID) +
                (1 | program_ID),
            family = binomial(link = "logit"),
            data = d)

summary(m3)
sjstats::icc(m3)

m4 <- glmer(profile_4 ~ 1 +
                (1 | participant_ID) +
                (1 | beep_ID) +
                (1 | program_ID),
            family = binomial(link = "logit"),
            data = d)

summary(m4)
sjstats::icc(m4)

m5 <- glmer(profile_5 ~ 1 +
                (1 | participant_ID) +
                (1 | beep_ID) +
                (1 | program_ID),
            family = binomial(link = "logit"),
            data = d)

summary(m5)
sjstats::icc(m5)

m6 <- glmer(profile_6 ~ 1 +
                (1 | participant_ID) +
                (1 | beep_ID) +
                (1 | program_ID),
            family = binomial(link = "logit"),
            data = d)

summary(m6)
sjstats::icc(m6)
```

```{r, prof-4}
m4a <- glmer(profile_4 ~ 1 +
                 dm_ask + dm_obs + dm_gen + dm_mod + dm_com +
                 overall_pre_interest + 
                 (1 | participant_ID) +
                 (1 | beep_ID) +
                 (1 | program_ID),
             family = binomial(link = "logit"),
             data = d)

summary(m4a)
fixef(m)
convert_log_odds(fixef(m4a))
sjstats::icc(m4a)

m4aa <- lmer(profile_4_p ~ 1 +
                dm_ask + dm_obs + dm_gen + dm_mod + dm_com +
                (1 | participant_ID) +
                (1 | beep_ID) +
                (1 | program_ID),
            data = d)

summary(m4aa)
 fixef(m4aa)
convert_log_odds(fixef(m4a))
sjstats::icc(m4a)
```

```{r, all-the-other-profs}
m1a <- glmer(profile_1 ~ 1 +
                 dm_ask + dm_obs + dm_gen + dm_mod + dm_com +
                 (1 | participant_ID) +
                 (1 | beep_ID) +
                 (1 | program_ID),
             family = binomial(link = "logit"),
             data = d)

summary(m1a)
sjstats::icc(m1a)

m2a <- glmer(profile_2 ~ 1 +
                 dm_ask + dm_obs + dm_gen + dm_mod + dm_com +
                 (1 | participant_ID) +
                 (1 | beep_ID) +
                 (1 | program_ID),
             family = binomial(link = "logit"),
             data = d)

summary(m2a)
sjstats::icc(m2a)

m3a <- glmer(profile_3 ~ 1 +
                 dm_ask + dm_obs + dm_gen + dm_mod + dm_com +
                 (1 | participant_ID) +
                 (1 | beep_ID) +
                 (1 | program_ID),
             family = binomial(link = "logit"),
             data = d)

summary(m3a)
sjstats::icc(m3a)

m4a <- glmer(profile_4 ~ 1 +
                 dm_ask + dm_obs + dm_gen + dm_mod + dm_com +
                 (1 | participant_ID) +
                 (1 | beep_ID) +
                 (1 | program_ID),
             family = binomial(link = "logit"),
             data = d)

summary(m4a)
sjstats::icc(m4a)

m5a <- glmer(profile_5 ~ 1 +
                 dm_ask + dm_obs + dm_gen + dm_mod + dm_com +
                 
                 (1 | participant_ID) +
                 (1 | beep_ID) +
                 (1 | program_ID),
             family = binomial(link = "logit"),
             data = d)

summary(m5a)
sjstats::icc(m5a)

m6a <- glmer(profile_6 ~ 1 +
                 dm_ask + dm_obs + dm_gen + dm_mod + dm_com +
                 (1 | participant_ID) +
                 (1 | beep_ID) +
                 (1 | program_ID),
             family = binomial(link = "logit"),
             data = d)

summary(m6a)
sjstats::icc(m6a)
```